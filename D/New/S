require('dotenv').config();
const express = require('express');
const { ApolloServer } = require('@apollo/server');
const { expressMiddleware } = require('@apollo/server/express4');
const cors = require('cors');
const bodyParser = require('body-parser');
const gql = require('graphql-tag');
const GraphQLJSON = require('graphql-type-json');
const {
  DynamoDBClient
} = require('@aws-sdk/client-dynamodb');
const {
  DynamoDBDocumentClient,
  GetCommand,
  PutCommand,
  QueryCommand
} = require('@aws-sdk/lib-dynamodb');

// === AWS Config ===
const REGION = process.env.AWS_REGION;
const TABLE_NAME = process.env.DYNAMODB_TABLE;
const PORT = process.env.PORT || 4000;

// === DynamoDB Setup ===
const client = new DynamoDBClient({ region: REGION });
const docClient = DynamoDBDocumentClient.from(client);

// === GraphQL Schema ===
const typeDefs = gql`
  scalar AWSDateTime
  scalar AWSTimestamp
  scalar AWSJSON

  interface DynamoDbBase {
    PK: ID!
    SK: ID!
    ExpiresAfter: AWSTimestamp
  }

  type Document implements DynamoDbBase {
    PK: ID!
    SK: ID!
    ObjectKey: ID
    ObjectStatus: String
    InitialEventTime: AWSDateTime
    QueuedTime: AWSDateTime
    WorkflowStartTime: AWSDateTime
    CompletionTime: AWSDateTime
    WorkflowExecutionArn: String
    WorkflowStatus: String
    PageCount: Int
    Metering: AWSJSON
    EvaluationReportUri: String
    EvaluationStatus: String
    SummaryReportUri: String
    ExpiresAfter: AWSTimestamp
    HITLStatus: String
    HITLReviewURL: String
  }

  input CreateDocumentInput {
    ObjectKey: ID
    ObjectStatus: String
    InitialEventTime: AWSDateTime
    QueuedTime: AWSDateTime
    ExpiresAfter: AWSTimestamp
  }

  type CreateDocumentOutput {
    ObjectKey: ID
  }

  type DocumentListItem implements DynamoDbBase {
    PK: ID!
    SK: ID!
    ObjectKey: ID
    InitialEventTime: AWSDateTime
    ExpiresAfter: AWSTimestamp
    HITLStatus: String
    HITLReviewURL: String
  }

  type DocumentList {
    Documents: [DocumentListItem]
    nextToken: String
  }

  type Query {
    getDocument(ObjectKey: ID!): Document
    listDocuments: DocumentList
  }

  type Mutation {
    createDocument(input: CreateDocumentInput!): CreateDocumentOutput
  }
`;

// === Resolvers ===
const resolvers = {
  AWSDateTime: {
    __parseValue: value => new Date(value),
    __serialize: value => new Date(value).toISOString(),
    __parseLiteral: ast => new Date(ast.value),
  },
  AWSTimestamp: {
    __parseValue: value => parseInt(value),
    __serialize: value => parseInt(value),
    __parseLiteral: ast => parseInt(ast.value),
  },
  AWSJSON: GraphQLJSON,

  Query: {
    getDocument: async (_, { ObjectKey }) => {
      const PK = `DOCUMENT#${ObjectKey}`;
      const SK = 'METADATA';

      const result = await docClient.send(new GetCommand({
        TableName: TABLE_NAME,
        Key: { PK, SK }
      }));

      return result.Item || null;
    },

    listDocuments: async () => {
      const result = await docClient.send(new QueryCommand({
        TableName: TABLE_NAME,
        IndexName: 'SK-index', // optional: only if you have GSI on SK
        KeyConditionExpression: 'SK = :sk',
        ExpressionAttributeValues: {
          ':sk': 'METADATA'
        },
        Limit: 25
      }));

      return {
        Documents: result.Items || [],
        nextToken: result.LastEvaluatedKey
          ? JSON.stringify(result.LastEvaluatedKey)
          : null
      };
    }
  },

  Mutation: {
    createDocument: async (_, { input }) => {
      const PK = `DOCUMENT#${input.ObjectKey}`;
      const SK = 'METADATA';

      const item = {
        PK,
        SK,
        ...input
      };

      await docClient.send(new PutCommand({
        TableName: TABLE_NAME,
        Item: item
      }));

      return { ObjectKey: input.ObjectKey };
    }
  }
};

// === Start Apollo Server ===
async function start() {
  const app = express();
  const server = new ApolloServer({ typeDefs, resolvers });

  await server.start();

  app.use('/graphql', cors(), bodyParser.json(), expressMiddleware(server));

  app.listen(PORT, () => {
    console.log(`ðŸš€ Apollo GraphQL ready at http://localhost:${PORT}/graphql`);
  });
}

start();
