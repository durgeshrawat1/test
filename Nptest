const express = require('express');
const bodyParser = require('body-parser');
const AWS = require('aws-sdk');
const crypto = require('crypto');

const app = express();
app.use(bodyParser.json());

const REGION = 'us-east-1';
const CLIENT_ID = 'YOUR_CLIENT_ID';
const CLIENT_SECRET = 'YOUR_CLIENT_SECRET';

const cognito = new AWS.CognitoIdentityServiceProvider({ region: REGION });

function getSecretHash(username, clientId, clientSecret) {
  return crypto.createHmac('SHA256', clientSecret)
               .update(username + clientId)
               .digest('base64');
}

app.post('/login', async (req, res) => {
  const { username, password } = req.body;

  if (!username || !password) {
    return res.status(400).send({ error: 'Username and password required' });
  }

  try {
    const params = {
      AuthFlow: 'USER_PASSWORD_AUTH',
      ClientId: CLIENT_ID,
      AuthParameters: {
        USERNAME: username,
        PASSWORD: password,
        SECRET_HASH: getSecretHash(username, CLIENT_ID, CLIENT_SECRET)
      }
    };

    const result = await cognito.initiateAuth(params).promise();
    res.send(result.AuthenticationResult);
  } catch (err) {
    res.status(400).send({ error: err.message });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
